{
  "description": "DeepStep v0 projections for append domain",
  "version": "0.1.0",
  "projections": [
    {
      "id": "reduce.append.base",
      "comment": "Reduce append(null, ys) -> ys",
      "pattern": {
        "mode": "deep_eval",
        "focus": {"op": "append", "xs": null, "ys": {"var": "ys"}},
        "context": {"var": "ctx"},
        "changed": {"var": "_c"}
      },
      "body": {
        "mode": "deep_eval",
        "focus": {"var": "ys"},
        "context": {"var": "ctx"},
        "changed": true
      }
    },
    {
      "id": "reduce.append.recursive",
      "comment": "Reduce append({head,tail}, ys) -> {head, tail:append(tail,ys)}",
      "pattern": {
        "mode": "deep_eval",
        "focus": {
          "op": "append",
          "xs": {"head": {"var": "h"}, "tail": {"var": "t"}},
          "ys": {"var": "ys"}
        },
        "context": {"var": "ctx"},
        "changed": {"var": "_c"}
      },
      "body": {
        "mode": "deep_eval",
        "focus": {
          "head": {"var": "h"},
          "tail": {"op": "append", "xs": {"var": "t"}, "ys": {"var": "ys"}}
        },
        "context": {"var": "ctx"},
        "changed": true
      }
    },
    {
      "id": "descend.dict.two_keys_head_tail",
      "comment": "Descend into dict with keys [head, tail] - focus on head first",
      "pattern": {
        "mode": "deep_eval",
        "focus": {"head": {"var": "h_val"}, "tail": {"var": "t_val"}},
        "context": {"var": "ctx"},
        "changed": {"var": "c"}
      },
      "body": {
        "mode": "deep_eval",
        "focus": {"var": "h_val"},
        "context": [
          {
            "type": "dict",
            "key": "head",
            "done": {},
            "remaining": ["tail"],
            "values": {"head": {"var": "h_val"}, "tail": {"var": "t_val"}}
          },
          {"var": "ctx"}
        ],
        "changed": {"var": "c"}
      }
    },
    {
      "id": "sibling.dict.to_tail",
      "comment": "Move from head to tail in dict traversal",
      "pattern": {
        "mode": "deep_eval",
        "focus": {"var": "done_val"},
        "context": [
          {
            "type": "dict",
            "key": "head",
            "done": {},
            "remaining": ["tail"],
            "values": {"var": "vals"}
          },
          {"var": "outer_ctx"}
        ],
        "changed": {"var": "c"}
      },
      "body": {
        "mode": "deep_eval",
        "focus": {"var": "tail_val"},
        "context": [
          {
            "type": "dict",
            "key": "tail",
            "done": {"head": {"var": "done_val"}},
            "remaining": [],
            "values": {"var": "vals"}
          },
          {"var": "outer_ctx"}
        ],
        "changed": {"var": "c"},
        "_extract": {"tail_val": ["vals", "tail"]}
      }
    },
    {
      "id": "ascend.dict.from_tail",
      "comment": "Ascend from tail, rebuild dict",
      "pattern": {
        "mode": "deep_eval",
        "focus": {"var": "tail_result"},
        "context": [
          {
            "type": "dict",
            "key": "tail",
            "done": {"head": {"var": "head_result"}},
            "remaining": [],
            "values": {"var": "_vals"}
          },
          {"var": "outer_ctx"}
        ],
        "changed": {"var": "c"}
      },
      "body": {
        "mode": "deep_eval",
        "focus": {"head": {"var": "head_result"}, "tail": {"var": "tail_result"}},
        "context": {"var": "outer_ctx"},
        "changed": {"var": "c"}
      }
    },
    {
      "id": "leaf.null",
      "comment": "Null is a leaf - trigger ascend/sibling",
      "pattern": {
        "mode": "deep_eval",
        "focus": null,
        "context": [{"var": "frame"}, {"var": "rest"}],
        "changed": {"var": "c"}
      },
      "body": {
        "mode": "deep_eval",
        "focus": null,
        "context": [{"var": "frame"}, {"var": "rest"}],
        "changed": {"var": "c"},
        "_note": "focus unchanged, sibling/ascend will handle"
      }
    },
    {
      "id": "leaf.int",
      "comment": "Integer is a leaf - stays as focus for sibling/ascend",
      "pattern": {
        "mode": "deep_eval",
        "focus": {"var": "n"},
        "context": [{"var": "frame"}, {"var": "rest"}],
        "changed": {"var": "c"},
        "_guard": "n is int"
      },
      "body": {
        "mode": "deep_eval",
        "focus": {"var": "n"},
        "context": [{"var": "frame"}, {"var": "rest"}],
        "changed": {"var": "c"}
      }
    },
    {
      "id": "restart",
      "comment": "At root with changes - restart traversal",
      "pattern": {
        "mode": "deep_eval",
        "focus": {"var": "f"},
        "context": [],
        "changed": true
      },
      "body": {
        "mode": "deep_eval",
        "focus": {"var": "f"},
        "context": [],
        "changed": false
      }
    },
    {
      "id": "unwrap",
      "comment": "At root, no changes - done, return result",
      "pattern": {
        "mode": "deep_eval",
        "focus": {"var": "result"},
        "context": [],
        "changed": false
      },
      "body": {"var": "result"}
    },
    {
      "id": "wrap",
      "comment": "Entry point - wrap value in deep_eval state",
      "pattern": {"var": "input"},
      "body": {
        "mode": "deep_eval",
        "focus": {"var": "input"},
        "context": [],
        "changed": false
      },
      "_note": "This must be LAST - catches anything not already wrapped"
    }
  ],
  "_issues": [
    "sibling.dict.to_tail uses _extract which is not standard Mu",
    "leaf.int uses _guard which needs type checking",
    "Need to handle arbitrary dict keys, not just head/tail",
    "Need list handling projections",
    "Projection order matters - REDUCE before DESCEND before LEAF"
  ],
  "_next_steps": [
    "Implement _extract as structural lookup",
    "Add type discrimination without _guard",
    "Generalize to arbitrary dict structures",
    "Add list projections"
  ]
}
