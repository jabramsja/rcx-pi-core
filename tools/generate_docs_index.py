#!/usr/bin/env python3
"""
Generate docs/README.md index automatically.

Scans docs/ subdirectories and creates a navigable index.
Run manually or as part of pre-commit to keep index fresh.

Usage:
    python tools/generate_docs_index.py
    python tools/generate_docs_index.py --check  # Verify index is up-to-date
"""

import argparse
import re
import sys
from pathlib import Path

# Directory descriptions (customize as needed)
DIR_DESCRIPTIONS = {
    "core": "Core specifications - read these first",
    "bytecode": "Bytecode VM documentation",
    "execution": "Execution semantics and traces",
    "schemas": "JSON schema definitions",
    "cli": "CLI tools and commands",
    "agents": "AI agent rig documentation",
    "audit": "Audit, governance, and compliance",
    "archive": "Historical/archived documentation",
    "latex": "LaTeX source files (paper)",
    "fixtures": "Test fixtures",
}

# Priority order for directories (higher = listed first)
DIR_PRIORITY = {
    "core": 100,
    "execution": 90,
    "bytecode": 80,
    "schemas": 70,
    "cli": 60,
    "agents": 50,
    "audit": 40,
    "archive": 10,
    "latex": 5,
    "fixtures": 5,
}


def extract_title(filepath: Path) -> str:
    """Extract title from markdown file (first # heading or filename)."""
    try:
        content = filepath.read_text(encoding="utf-8")
        # Look for first # heading
        match = re.search(r"^#\s+(.+)$", content, re.MULTILINE)
        if match:
            return match.group(1).strip()
    except Exception:
        pass
    # Fallback to filename without extension
    return filepath.stem.replace("_", " ").replace("-", " ")


def generate_index(docs_dir: Path) -> str:
    """Generate the README.md content."""
    lines = [
        "# Documentation Index",
        "",
        "> Auto-generated by `tools/generate_docs_index.py`",
        "> Run `python tools/generate_docs_index.py` to update",
        "",
        "## Quick Links",
        "",
        "| Category | Description |",
        "|----------|-------------|",
    ]

    # Collect directories
    dirs = []
    for d in docs_dir.iterdir():
        if d.is_dir() and not d.name.startswith("."):
            dirs.append(d)

    # Sort by priority then name
    dirs.sort(key=lambda d: (-DIR_PRIORITY.get(d.name, 0), d.name))

    # Add quick links table
    for d in dirs:
        desc = DIR_DESCRIPTIONS.get(d.name, "")
        lines.append(f"| [{d.name}/](#{d.name}) | {desc} |")

    lines.append("")

    # Add detailed sections for each directory
    for d in dirs:
        lines.append(f"## {d.name}")
        lines.append("")

        desc = DIR_DESCRIPTIONS.get(d.name, "")
        if desc:
            lines.append(f"*{desc}*")
            lines.append("")

        # Find all markdown files
        md_files = sorted(d.glob("*.md"))
        if md_files:
            lines.append("| File | Title |")
            lines.append("|------|-------|")
            for f in md_files:
                title = extract_title(f)
                rel_path = f.relative_to(docs_dir)
                lines.append(f"| [{f.name}]({rel_path}) | {title} |")
            lines.append("")
        else:
            # Check for other files
            other_files = [f for f in d.iterdir() if f.is_file() and not f.name.startswith(".")]
            if other_files:
                lines.append(f"*{len(other_files)} files (non-markdown)*")
                lines.append("")
            else:
                subdirs = [sd for sd in d.iterdir() if sd.is_dir()]
                if subdirs:
                    lines.append(f"*Contains subdirectories: {', '.join(sd.name for sd in subdirs)}*")
                    lines.append("")

    # Footer
    lines.append("---")
    lines.append("")
    lines.append("*To add a new doc: create the file, then run `python tools/generate_docs_index.py`*")
    lines.append("")

    return "\n".join(lines)


def main():
    parser = argparse.ArgumentParser(description="Generate docs/README.md index")
    parser.add_argument("--check", action="store_true", help="Check if index is up-to-date")
    args = parser.parse_args()

    # Find docs directory
    script_dir = Path(__file__).parent
    docs_dir = script_dir.parent / "docs"

    if not docs_dir.exists():
        print(f"Error: docs directory not found at {docs_dir}")
        sys.exit(1)

    readme_path = docs_dir / "README.md"
    new_content = generate_index(docs_dir)

    if args.check:
        # Check mode - verify index is up-to-date
        if readme_path.exists():
            current_content = readme_path.read_text(encoding="utf-8")
            if current_content.strip() == new_content.strip():
                print("docs/README.md is up-to-date")
                sys.exit(0)
            else:
                print("docs/README.md is OUT OF DATE")
                print("Run: python tools/generate_docs_index.py")
                sys.exit(1)
        else:
            print("docs/README.md does not exist")
            print("Run: python tools/generate_docs_index.py")
            sys.exit(1)
    else:
        # Generate mode
        readme_path.write_text(new_content, encoding="utf-8")
        print(f"Generated {readme_path}")

        # Count what was indexed
        md_count = len(list(docs_dir.rglob("*.md")))
        dir_count = len([d for d in docs_dir.iterdir() if d.is_dir()])
        print(f"  {dir_count} directories, {md_count} markdown files indexed")


if __name__ == "__main__":
    main()
