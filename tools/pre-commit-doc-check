#!/usr/bin/env bash
# Git pre-commit hook for doc consistency
# Install: ln -sf ../../tools/pre-commit-doc-check .git/hooks/pre-commit
#
# This hook:
# 1. Runs check_docs_consistency.sh (validates STATUS.md matches reality)
# 2. Checks debt ceiling is not exceeded
# 3. Warns if rcx_pi/ or seeds/ changed but STATUS.md wasn't touched
#
# All checks are WARNINGS, not blockers. CI runs pytest and catches real issues.
# Use --no-verify to skip entirely (not recommended).

set -e

cd "$(dirname "$0")/../.." 2>/dev/null || cd "$(git rev-parse --show-toplevel)"

# === 1. Run doc consistency validation ===
if [ -f "./tools/check_docs_consistency.sh" ]; then
    if ! ./tools/check_docs_consistency.sh 2>/dev/null; then
        echo ""
        echo "‚ö†Ô∏è  Doc consistency check found issues (see above)"
        echo "   CI will catch this - but consider fixing now"
        echo ""
    fi
fi

# === 2. Check debt ceiling ===
if [ -f "./tools/debt_dashboard.sh" ]; then
    DEBT_JSON=$(./tools/debt_dashboard.sh --json 2>/dev/null || echo '{}')
    CURRENT=$(echo "$DEBT_JSON" | grep -o '"total_semantic": [0-9]*' | grep -o '[0-9]*' || echo "0")
    THRESHOLD=$(grep -E '^THRESHOLD:' STATUS.md 2>/dev/null | grep -o '[0-9]*' || echo "999")

    if [ "$CURRENT" -gt "$THRESHOLD" ]; then
        echo ""
        echo "üö® DEBT CEILING EXCEEDED: $CURRENT > $THRESHOLD"
        echo "   Run ./tools/debt_dashboard.sh to see debt locations"
        echo "   Fix debt or update threshold in STATUS.md before committing"
        echo ""
    fi
fi

# === 2. Get staged files ===
STAGED_FILES=$(git diff --cached --name-only)

RCX_CHANGED=$(echo "$STAGED_FILES" | grep -E '^rcx_pi/' || true)
SEEDS_CHANGED=$(echo "$STAGED_FILES" | grep -E '^seeds/' || true)
STATUS_CHANGED=$(echo "$STAGED_FILES" | grep -E '^STATUS\.md$' || true)

# === 3. Warn if core code changed without STATUS.md ===
if [ -n "$RCX_CHANGED" ] || [ -n "$SEEDS_CHANGED" ]; then
    if [ -z "$STATUS_CHANGED" ]; then
        echo ""
        echo "‚ö†Ô∏è  Core code changed but STATUS.md was not updated"
        echo ""
        echo "Changed files:"
        [ -n "$RCX_CHANGED" ] && echo "$RCX_CHANGED" | sed 's/^/  /'
        [ -n "$SEEDS_CHANGED" ] && echo "$SEEDS_CHANGED" | sed 's/^/  /'
        echo ""
        echo "CI will run grounding tests - they'll fail if docs drift."
        echo ""
    fi
fi

# Always allow commit - CI catches real issues
exit 0
