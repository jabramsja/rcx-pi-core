#!/usr/bin/env bash
# Git pre-commit hook for doc consistency
# Install: ln -sf ../../tools/pre-commit-doc-check .git/hooks/pre-commit
#
# This hook:
# 1. Runs check_docs_consistency.sh (validates STATUS.md matches reality)
# 2. Warns if rcx_pi/ or seeds/ changed but STATUS.md wasn't touched
#
# Warnings don't block commits - they're advisory reminders.

set -e

cd "$(dirname "$0")/../.." 2>/dev/null || cd "$(git rev-parse --show-toplevel)"

# === 1. Run doc consistency validation (automatic) ===
if [ -f "./tools/check_docs_consistency.sh" ]; then
    if ! ./tools/check_docs_consistency.sh 2>/dev/null; then
        echo ""
        echo "⚠️  Doc consistency check found issues (see above)"
        echo "   Continuing with commit - please review and fix if needed"
        echo ""
    fi
fi

# === 2. Check if core code changed without STATUS.md update ===
STAGED_FILES=$(git diff --cached --name-only)

RCX_CHANGED=$(echo "$STAGED_FILES" | grep -E '^rcx_pi/' || true)
SEEDS_CHANGED=$(echo "$STAGED_FILES" | grep -E '^seeds/' || true)
STATUS_CHANGED=$(echo "$STAGED_FILES" | grep -E '^STATUS\.md$' || true)

if [ -n "$RCX_CHANGED" ] || [ -n "$SEEDS_CHANGED" ]; then
    if [ -z "$STATUS_CHANGED" ]; then
        echo ""
        echo "⚠️  Core code changed but STATUS.md was not updated"
        echo ""
        echo "Changed files:"
        [ -n "$RCX_CHANGED" ] && echo "$RCX_CHANGED" | sed 's/^/  /'
        [ -n "$SEEDS_CHANGED" ] && echo "$SEEDS_CHANGED" | sed 's/^/  /'
        echo ""
        echo "Please verify: Does this affect debt count or current phase?"
        echo ""
    fi
fi

# Always allow commit (warnings are advisory, not blocking)
exit 0
